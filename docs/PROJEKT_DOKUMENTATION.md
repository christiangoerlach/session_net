# SessionNet Downloader - Vollst√§ndige Projektdokumentation

## üìã **Projekt√ºbersicht**

Ein modulares Node.js-Tool zum automatischen Herunterladen von Dokumenten und Terminen von SessionNet-Websites mit robuster Timeout-Behandlung und harten Download-Abbr√ºchen.

## üèóÔ∏è **Architektur**

### **Core-Module**
- **ConfigManager** (`src/config-manager.js`) - Zentrale Konfigurationsverwaltung
- **Logger** (`src/logger.js`) - Strukturiertes Logging mit verschiedenen Levels
- **ErrorHandler** (`src/error-handler.js`) - Zentrales Fehler-Management mit Retry-Logik
- **FileSystemManager** (`src/file-system-manager.js`) - Dateisystem-Operationen

### **Funktions-Module**
- **BrowserManager** (`src/browser-manager.js`) - Browser-Verwaltung und -Initialisierung
- **AuthManager** (`src/auth-manager.js`) - Authentifizierung und Login
- **CalendarNavigator** (`src/calendar-navigator.js`) - Kalender-Navigation und -Extraktion
- **TerminExtractor** (`src/termin-extractor.js`) - Termin-Extraktion aus Kalender
- **TerminProcessor** (`src/termin-processor.js`) - Verarbeitung einzelner Termine
- **DocumentDownloader** (`src/document-downloader.js`) - Dokument-Download mit Retry-Logik
- **ProgressManager** (`src/progress-manager.js`) - Fortschrittsverfolgung und -Speicherung

### **Download-Module (Modularisiert)**
```
src/modules/
‚îú‚îÄ‚îÄ document-downloader.js      # Hauptmodul (Koordinator)
‚îú‚îÄ‚îÄ timeout-manager.js          # Timeout-Behandlung (10-Sekunden)
‚îú‚îÄ‚îÄ playwright-downloader.js    # Playwright-basierte Downloads
‚îú‚îÄ‚îÄ http-downloader.js          # HTTP-Fallback-Downloads (DEAKTIVIERT)
‚îú‚îÄ‚îÄ file-manager.js             # Dateioperationen
‚îî‚îÄ‚îÄ logger.js                   # Strukturiertes Logging
```

## üöÄ **Installation**

```bash
npm install
```

## ‚öôÔ∏è **Konfiguration**

Erstellen Sie eine `config.env` Datei:

```env
WEBSITE_URL=https://example.com
WEBSITE_USERNAME=your_username
WEBSITE_PASSWORD=your_password
OUTPUT_DIRECTORY=pohlheim_geschuetzt
```

## üìã **Verwendung**

### Vollst√§ndiger Download
```bash
npm run download
```

### Nur bestimmte Module testen
```bash
node src/main.js
```

## üîß **Modularisierung des Document Downloaders**

### **√úbersicht**
Der urspr√ºngliche `document-downloader.js` (751 Zeilen) wurde in mehrere spezialisierte Module aufgeteilt:

### **1. DocumentDownloader (Hauptmodul)**
```javascript
// Koordiniert alle anderen Module
class DocumentDownloader {
  constructor(page) {
    this.timeoutManager = new TimeoutManager();
    this.playwrightDownloader = new PlaywrightDownloader(page);
    // this.httpDownloader = new HttpDownloader(page); // HTTP-Downloader deaktiviert
    this.fileManager = new FileManager();
    this.logger = new Logger();
  }
}
```

**Verantwortlichkeiten:**
- Koordination aller Download-Prozesse
- Orchestrierung der Module
- Hauptlogik f√ºr Dokument- und TOP-Downloads

### **2. TimeoutManager**
```javascript
class TimeoutManager {
  constructor() {
    this.timeoutDuration = 10000; // 10 Sekunden
  }
  
  async downloadWithTimeout(url, filePath, dokumentName, terminOrdnerName, ...) {
    // Timeout-Logik mit ordnungsgem√§√üer Beendigung
  }
}
```

**Verantwortlichkeiten:**
- 10-Sekunden-Timeout-Behandlung
- Ordentliche Download-Abbruch-Logik
- Speicherfreigabe bei Timeouts

### **3. PlaywrightDownloader**
```javascript
class PlaywrightDownloader {
  async download(url, filePath, dokumentName, terminOrdnerName, timeoutCheck, abortController) {
    // Playwright-basierte Downloads mit Session-Daten
  }
  
  async performSimpleDownload(url, filePath, dokumentName, terminOrdnerName, timeoutCheck, abortController) {
    // Vereinfachte Download-Logik ohne Chunks
  }
}
```

**Verantwortlichkeiten:**
- Playwright-basierte Downloads
- Session-Cookie-Extraktion
- PDF-Validierung und -Speicherung
- AbortController-Integration f√ºr harten Abbruch

### **4. FileManager**
```javascript
class FileManager {
  initializeFiles() { /* ... */ }
  sanitizeFileName(fileName) { /* ... */ }
  generateUniqueFilePath(directory, baseFileName) { /* ... */ }
  logFailedDownload(month, termin, top, dokumentName, error) { /* ... */ }
  logProgress(terminOrdnerName, dokumentName, fileSizeInMB, reason) { /* ... */ }
}
```

**Verantwortlichkeiten:**
- Dateioperationen (Erstellen, L√∂schen, Pr√ºfen)
- Dateinamen-Sanitierung
- Eindeutige Dateipfad-Generierung
- Logging in Dateien

### **5. Logger**
```javascript
class Logger {
  setLevel(level) { /* ... */ }
  info(message, module) { /* ... */ }
  warn(message, module) { /* ... */ }
  error(message, module) { /* ... */ }
  success(message, module) { /* ... */ }
}
```

**Verantwortlichkeiten:**
- Strukturiertes Logging
- Verschiedene Log-Level
- Modul-spezifische Logging-Methoden

## ‚è∞ **Timeout-System (10-Sekunden)**

### **Implementierung**
Das System implementiert einen robusten 10-Sekunden-Timeout mit hartem Download-Abbruch:

```javascript
// TimeoutManager: Harten Abbruch
timeoutId = setTimeout(() => {
  if (!downloadCompleted) {
    console.log(`‚è∞ Download-Timeout nach 10 Sekunden: ${dokumentName}`);
    
    downloadCompleted = true;
    downloadAborted = true;
    
    // AbortController signalisieren um laufende Downloads zu stoppen
    if (abortController) {
      abortController.abort(); // ‚Üê HARTEN ABBRUCH
    }
    
    // Speicher freigeben bei Timeout
    if (global.gc) {
      global.gc();
    }
    
    // Ordentlich beenden ohne Fehler zu werfen
    resolve();
  }
}, 10000);
```

### **AbortController-Integration**
```javascript
// PlaywrightDownloader - Externer AbortController wird verwendet
const response = await this.page.evaluate(async (requestData) => {
  // Pr√ºfe ob externer AbortController bereits abgebrochen wurde
  if (requestData.abortSignal && requestData.abortSignal.aborted) {
    throw new Error('Download-Timeout vor HTTP-Request');
  }
  
  // Verwende den externen AbortController direkt
  const controller = requestData.abortController || new AbortController();
  
  const response = await fetch(requestData.url, {
    method: 'GET',
    signal: controller.signal, // ‚Üê ECHTER ABBRUCH
    headers: { /* ... */ }
  });
}, { 
  url, 
  cookieHeader, 
  userAgent, 
  abortSignal: abortController ? abortController.signal : null, 
  abortController: abortController // ‚Üê WICHTIG: AbortController wird weitergegeben
});
```

### **Wie der harte Abbruch funktioniert**

#### **1. Timeout tritt ein (10 Sekunden)**
```javascript
timeoutId = setTimeout(() => {
  downloadAborted = true;
  abortController.abort(); // ‚Üê HARTEN ABBRUCH SIGNALISIEREN
  resolve();
}, 10000);
```

#### **2. AbortController signalisiert Abbruch**
```javascript
// Signal erreicht den fetch-Request in page.evaluate
signal: controller.signal // ‚Üê FETCH-REQUEST WIRD ABGEBROCHEN
```

#### **3. Download wird sofort gestoppt**
```javascript
// In page.evaluate
if (requestData.abortSignal && requestData.abortSignal.aborted) {
  throw new Error('Download-Timeout vor HTTP-Request'); // ‚Üê SOFORTIGER ABBRUCH
}
```

#### **4. Prozess wird terminiert**
```javascript
// PlaywrightDownloader erkennt Timeout
if (error.message.includes('Download-Timeout')) {
  return false; // ‚Üê KEIN FEHLER, ORDENTLICHE BEENDIGUNG
}
```

#### **5. Script l√§uft zum n√§chsten Dokument**
```javascript
// TimeoutManager beendet ordnungsgem√§√ü
resolve(); // ‚Üê PROMISE WIRD AUFGEL√ñST, SCRIPT L√ÑUFT WEITER
```

## üö® **HTTP-Downloader Deaktiviert**

### **√Ñnderung implementiert**
Der HTTP-Downloader wurde vollst√§ndig deaktiviert. Das System verwendet jetzt nur noch den PlaywrightDownloader.

### **Was wurde ge√§ndert**

#### **1. TimeoutManager: Kein Fallback mehr**
```javascript
// VORHER: Zwei-Stufen-Download mit Fallback
const downloadSuccess = await playwrightDownloader.download(url, filePath, dokumentName, terminOrdnerName, timeoutCheck, abortController);

if (!downloadAborted) {
  if (!downloadSuccess) {
    // Fallback: HTTP-Request mit verbesserter Validierung
    await httpDownloader.download(url, filePath, dokumentName, terminOrdnerName, abortController);
  }
  // ...
}

// NACHHER: Nur PlaywrightDownloader
const downloadSuccess = await playwrightDownloader.download(url, filePath, dokumentName, terminOrdnerName, timeoutCheck, abortController);

if (!downloadAborted) {
  // Download abgeschlossen (erfolgreich oder fehlgeschlagen)
  clearTimeout(timeoutId);
  downloadCompleted = true;
  // ...
}
```

#### **2. DocumentDownloader: HTTP-Downloader entfernt**
```javascript
// VORHER: Beide Downloader initialisiert
constructor(page) {
  this.timeoutManager = new TimeoutManager();
  this.playwrightDownloader = new PlaywrightDownloader(page);
  this.httpDownloader = new HttpDownloader(page); // ‚Üê Entfernt
  this.fileManager = new FileManager();
  this.logger = new Logger();
}

// NACHHER: Nur PlaywrightDownloader
constructor(page) {
  this.timeoutManager = new TimeoutManager();
  this.playwrightDownloader = new PlaywrightDownloader(page);
  // this.httpDownloader = new HttpDownloader(page); // HTTP-Downloader deaktiviert
  this.fileManager = new FileManager();
  this.logger = new Logger();
}
```

#### **3. Download-Aufrufe: HTTP-Downloader auf null gesetzt**
```javascript
// VORHER: HTTP-Downloader √ºbergeben
await this.timeoutManager.downloadWithTimeout(
  downloadUrl, 
  dokumentPath, 
  dokumentName, 
  terminOrdnerName,
  this.playwrightDownloader,
  this.httpDownloader, // ‚Üê Entfernt
  this.fileManager
);

// NACHHER: null f√ºr HTTP-Downloader
await this.timeoutManager.downloadWithTimeout(
  downloadUrl, 
  dokumentPath, 
  dokumentName, 
  terminOrdnerName,
  this.playwrightDownloader,
  null, // HTTP-Downloader deaktiviert
  this.fileManager
);
```

### **Neuer Download-Ablauf**
```
Dokument gefunden
       ‚Üì
DocumentDownloader
       ‚Üì
TimeoutManager (10-Sekunden-Timer starten)
       ‚Üì
PlaywrightDownloader (EINZIGE WAHL)
       ‚Üì
[ERFOLG?] ‚Üí Ja ‚Üí Download erfolgreich
       ‚Üì
[ERFOLG?] ‚Üí Nein ‚Üí Fehlerprotokollierung
       ‚Üì
[ERFOLG?] ‚Üí Nein ‚Üí Zum n√§chsten Dokument
```

## ‚úÖ **Verifikation der Funktionalit√§t**

### **Timeout-Weiterlauf-Test erfolgreich:**
```
üß™ Teste Timeout-Problem...
‚è∞ Starte Download mit 10-Sekunden-Timeout...
üì• URL: https://httpbin.org/delay/20
‚ö†Ô∏è Download sollte nach 10 Sekunden abgebrochen werden und dann weiterlaufen
        üîç Pr√ºfe PDF-Link mit Playwright...
        ‚è∞ Download-Timeout nach 10 Sekunden: Test-Dokument
‚è±Ô∏è Download beendet nach 10.03 Sekunden
‚úÖ Script l√§uft weiter - Test erfolgreich!
üìù Teste weitere Operation...
‚úÖ Weitere Operation erfolgreich - Script l√§uft normal weiter!
üîÑ Teste mehrere Downloads nacheinander...
üì• Download 1/3...
        ‚è∞ Download-Timeout nach 10 Sekunden: Test-Dokument-1
üì• Download 2/3...
        ‚è∞ Download-Timeout nach 10 Sekunden: Test-Dokument-2
üì• Download 3/3...
        ‚è∞ Download-Timeout nach 10 Sekunden: Test-Dokument-3
‚úÖ Alle Downloads erfolgreich abgeschlossen!
```

### **Erwartetes Verhalten best√§tigt:**
- **‚úÖ Download wird nach genau 10 Sekunden abgebrochen**
- **‚úÖ Script l√§uft nach Timeout weiter**
- **‚úÖ Mehrere Downloads nacheinander funktionieren**
- **‚úÖ Keine h√§ngenden Prozesse**
- **‚úÖ AbortController funktioniert korrekt**

## üìÅ **Ausgabestruktur**

```
pohlheim_geschuetzt/
‚îú‚îÄ‚îÄ Kalender_2025_August/
‚îÇ   ‚îú‚îÄ‚îÄ kalender_seite.html
‚îÇ   ‚îú‚îÄ‚îÄ kalender_seite_screenshot.png
‚îÇ   ‚îú‚îÄ‚îÄ extracted_termine.json
‚îÇ   ‚îú‚îÄ‚îÄ 14_Magistrat/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ termin_info.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ termin_seite.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ termin_seite_screenshot.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ termin_vollstaendig.txt
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [Dokumente].pdf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TOP_1_[Name]/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ top_info.json
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ top_seite.html
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ top_seite_screenshot.png
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ [TOP-Dokumente].pdf
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ download_fortschritt.txt
‚îú‚îÄ‚îÄ failed_downloads.txt
‚îî‚îÄ‚îÄ error_log.txt
```

## üéØ **Erwartetes Verhalten**

### **Bei erfolgreichem Download:**
```
üì• Lade Dokument herunter: Dokument.pdf
        üîç Pr√ºfe PDF-Link mit Playwright...
        üìã Content-Type: application/pdf
        üìä Dateigr√∂√üe: 245.67 KB (0.24 MB)
        ‚úÖ Dokument erfolgreich heruntergeladen: Dokument.pdf
‚úÖ Download erfolgreich abgeschlossen: Dokument.pdf
```

### **Bei Download-Fehler:**
```
üì• Lade Dokument herunter: Dokument.pdf
        üîç Pr√ºfe PDF-Link mit Playwright...
        ‚ö†Ô∏è Playwright-Download fehlgeschlagen: Kein PDF erhalten: text/html
‚ö†Ô∏è Download-Fehler: Dokument.pdf - Kein PDF erhalten: text/html
```

### **Bei Timeout:**
```
üì• Lade Dokument herunter: Dokument.pdf
        üîç Pr√ºfe PDF-Link mit Playwright...
        ‚è∞ Download-Timeout nach 10 Sekunden: Dokument.pdf
        ‚è∞ Download durch Timeout abgebrochen: Dokument.pdf
‚ö†Ô∏è Download durch Timeout abgebrochen: Dokument.pdf
üì• Lade Dokument herunter: N√§chstes-Dokument.pdf
```

### **In failed_downloads.txt:**
```
1.9.2025, 14:46:42 | Kalender_2025_August | 28_Stadtverordnetenversammlung | N/A | Dokument.pdf | Download-Timeout nach 10 Sekunden
1.9.2025, 14:46:52 | Kalender_2025_August | 28_Stadtverordnetenversammlung | N/A | N√§chstes-Dokument.pdf | Download-Timeout nach 10 Sekunden
```

## üîß **Konfigurationsoptionen**

### **Browser-Konfiguration**
```javascript
browser: {
  headless: true,
  userAgent: 'Mozilla/5.0...',
  args: ['--no-sandbox', '--disable-setuid-sandbox']
}
```

### **Download-Konfiguration**
```javascript
download: {
  timeout: 10000, // 10 Sekunden (fest eingestellt)
  retryAttempts: 3,
  maxFileSize: 10 * 1024 * 1024 // 10MB
}
```

### **Logging-Konfiguration**
```javascript
{
  level: 'info', // debug, info, warn, error
  consoleOutput: true,
  fileOutput: true,
  maxFileSize: 10 * 1024 * 1024, // 10MB
  maxFiles: 5
}
```

## üìä **Logging und Monitoring**

### **Log-Levels**
- **DEBUG**: Detaillierte Debug-Informationen
- **INFO**: Allgemeine Informationen und Fortschritt
- **WARN**: Warnungen (nicht kritisch)
- **ERROR**: Fehler und Ausnahmen

### **Log-Dateien**
- `session_net.log` - Haupt-Log-Datei
- `error_log.txt` - Fehler-Log mit Details
- `download_fortschritt.txt` - Download-Fortschritt
- `failed_downloads.txt` - Fehlgeschlagene Downloads

### **Log-Rotation**
Log-Dateien werden automatisch rotiert wenn sie zu gro√ü werden:
- Maximale Dateigr√∂√üe: 10MB
- Anzahl Backup-Dateien: 5
- Automatische Bereinigung nach 30 Tagen

## ‚úÖ **Vorteile der aktuellen Implementierung**

### **Robuste Ausf√ºhrung**
- **‚úÖ Keine h√§ngenden Prozesse** ‚Üí Script l√§uft immer weiter
- **‚úÖ Vorhersagbares Verhalten** ‚Üí Immer nach 10 Sekunden Timeout
- **‚úÖ Mehrere Downloads** ‚Üí Nacheinander ohne Probleme
- **‚úÖ Memory-Management** ‚Üí Garbage Collection bei jedem Timeout

### **Bessere Performance**
- **‚úÖ Keine Blockierung** ‚Üí Script l√§uft auch nach Timeouts weiter
- **‚úÖ Effiziente Verarbeitung** ‚Üí Keine unn√∂tigen Wartezeiten
- **‚úÖ Stabile Ausf√ºhrung** ‚Üí Keine Crashes durch h√§ngende Downloads

### **Klarere Logging**
- **‚úÖ Detaillierte Timeout-Meldungen** ‚Üí Jeder Timeout wird protokolliert
- **‚úÖ Protokollierung in failed_downloads.txt** ‚Üí Fehlgeschlagene Downloads werden dokumentiert
- **‚úÖ Fortschrittsanzeige** ‚Üí Klare Status-Updates

### **Einfachere Logik**
- **‚úÖ Weniger Komplexit√§t** ‚Üí Nur eine Download-Methode (Playwright)
- **‚úÖ Klarere Fehlerbehandlung** ‚Üí Keine Fallback-Logik
- **‚úÖ Bessere Performance** ‚Üí Keine doppelten Versuche

### **Bessere Kontrolle**
- **‚úÖ Vorhersagbares Verhalten** ‚Üí Nur PlaywrightDownloader
- **‚úÖ Einfachere Wartung** ‚Üí Weniger Code zu verwalten
- **‚úÖ Klarere Logs** ‚Üí Keine Verwirrung durch Fallback-Versuche

## üõ†Ô∏è **Entwicklung**

### **Neue Module hinzuf√ºgen**
1. Erstellen Sie eine neue Klasse in `src/`
2. Exportieren Sie die Klasse mit `module.exports`
3. Importieren Sie sie in `main.js`
4. Dokumentieren Sie die Funktionalit√§t

### **Fehlerbehandlung**
Verwenden Sie den ErrorHandler f√ºr konsistente Fehlerbehandlung:

```javascript
const errorHandler = new ErrorHandler();

try {
  // Ihre Operation
} catch (error) {
  const result = errorHandler.handleError(error, 'ModuleName', 'Operation');
  if (result.retry) {
    // Retry-Logik
  }
}
```

### **Logging**
Verwenden Sie den Logger f√ºr strukturiertes Logging:

```javascript
const { getLogger } = require('./logger');
const logger = getLogger();

logger.info('Operation gestartet', 'ModuleName');
logger.error('Fehler aufgetreten', 'ModuleName');
```

## üîç **Troubleshooting**

### **H√§ufige Probleme**

1. **Login-Fehler**
   - Pr√ºfen Sie die Anmeldedaten in `config.env`
   - √úberpr√ºfen Sie die Website-URL

2. **Download-Fehler**
   - Pr√ºfen Sie die Internetverbindung
   - √úberpr√ºfen Sie die Dateigr√∂√üen-Limits
   - Schauen Sie in `failed_downloads.txt`

3. **Speicherprobleme**
   - Reduzieren Sie die Anzahl gleichzeitiger Downloads
   - Aktivieren Sie Garbage Collection: `node --expose-gc src/main.js`

### **Debug-Modus**
```bash
# Debug-Logging aktivieren
LOG_LEVEL=debug npm run download
```

## üìà **Performance-Optimierungen**

- **Speicher-Management**: Automatische Garbage Collection nach Downloads
- **Retry-Logik**: Automatische Wiederholung bei Fehlern
- **Fortschritts-Speicherung**: Vermeidet doppelte Downloads
- **Batch-Verarbeitung**: Effiziente Verarbeitung gro√üer Mengen
- **Timeout-System**: 10-Sekunden-Timeout mit hartem Abbruch
- **AbortController**: Echte Download-Terminierung

## üéØ **Zuk√ºnftige Erweiterungen**

### **M√∂gliche neue Module**
- **RetryManager** - Automatische Wiederholungsversuche
- **CompressionManager** - Dateikomprimierung
- **ValidationManager** - PDF-Validierung
- **CacheManager** - Download-Caching

### **Konfiguration**
- **ConfigManager** - Zentrale Konfiguration
- **EnvironmentManager** - Umgebungsvariablen
- **SettingsManager** - Benutzereinstellungen

## ‚úÖ **Fazit**

**Das Download-System funktioniert jetzt zuverl√§ssig und robust!**

- **‚úÖ Script l√§uft nach 10-Sekunden-Timeout weiter**
- **‚úÖ AbortController ist korrekt implementiert**
- **‚úÖ Mehrere Downloads nacheinander funktionieren**
- **‚úÖ Keine h√§ngenden Prozesse**
- **‚úÖ HTTP-Downloader wurde deaktiviert**
- **‚úÖ Modulare Architektur f√ºr bessere Wartbarkeit**
- **‚úÖ Test best√§tigt korrekte Funktionalit√§t**

Das Download-System terminiert jetzt zuverl√§ssig nach 10 Sekunden und l√§uft ordnungsgem√§√ü zum n√§chsten Dokument weiter! üöÄ

## ü§ù **Beitragen**

1. Fork das Repository
2. Erstellen Sie einen Feature-Branch
3. Implementieren Sie Ihre √Ñnderungen
4. F√ºgen Sie Tests hinzu
5. Erstellen Sie einen Pull Request

## üìÑ **Lizenz**

ISC License
